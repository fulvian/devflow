# DevFlow Prometheus Alerting Rules
# Task ID: DEVFLOW-MONITOR-003
# Purpose: Monitor critical DevFlow metrics with progressive alert severity for Context7 quality degradation and task failures

groups:
  - name: devflow-context7-quality
    rules:
      # Context7 Quality Degradation Alerts
      - alert: Context7QualityCritical
        expr: devflow_context7_quality_score < 0.5
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Context7 quality score critically low (< 0.5)"
          description: "Context7 quality score has dropped below critical threshold of 0.5 for more than 1 minute. Immediate attention required."
          runbook_url: "https://internal.runbook/context7-quality-degradation"

      - alert: Context7QualityWarning
        expr: devflow_context7_quality_score < 0.75
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Context7 quality score below threshold (< 0.75)"
          description: "Context7 quality score has dropped below 0.75 for more than 5 minutes. This affects Full Mode operations."
          runbook_url: "https://internal.runbook/context7-quality-degradation"

  - name: devflow-task-performance
    rules:
      # Task Execution Time Alerts
      - alert: TaskExecutionTimeCritical
        expr: avg(rate(devflow_task_execution_seconds_sum[5m]) / rate(devflow_task_execution_seconds_count[5m])) > 120
        for: 2m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Task execution time critically high (> 120s)"
          description: "Average task execution time has exceeded 120 seconds for more than 2 minutes. System performance severely degraded."
          runbook_url: "https://internal.runbook/task-performance-degradation"

      - alert: TaskExecutionTimeWarning
        expr: avg(rate(devflow_task_execution_seconds_sum[5m]) / rate(devflow_task_execution_seconds_count[5m])) > 60
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Task execution time elevated (> 60s)"
          description: "Average task execution time has exceeded 60 seconds for more than 5 minutes. Performance degradation detected."
          runbook_url: "https://internal.runbook/task-performance-degradation"

      # Task Failure Rate Alerts
      - alert: TaskFailureRateCritical
        expr: rate(devflow_task_failures_total[5m]) / rate(devflow_task_executions_total[5m]) > 0.2
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Task failure rate critically high (> 20%)"
          description: "Task failure rate has exceeded 20% for more than 1 minute. Immediate investigation required."
          runbook_url: "https://internal.runbook/task-failure-investigation"

      - alert: TaskFailureRateWarning
        expr: rate(devflow_task_failures_total[5m]) / rate(devflow_task_executions_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Task failure rate elevated (> 5%)"
          description: "Task failure rate has exceeded 5% for more than 5 minutes. Monitoring recommended."
          runbook_url: "https://internal.runbook/task-failure-investigation"

  - name: devflow-orchestrator
    rules:
      # Orchestrator Failure Detection
      - alert: OrchestratorTimeoutCritical
        expr: rate(devflow_orchestrator_timeouts_total[5m]) > 0.5
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Orchestrator timeout rate critically high (> 0.5/s)"
          description: "Orchestrator is experiencing timeout rates exceeding 0.5 per second. Critical system functionality affected."
          runbook_url: "https://internal.runbook/orchestrator-timeout"

      - alert: OrchestratorTimeoutWarning
        expr: rate(devflow_orchestrator_timeouts_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Orchestrator timeout rate elevated (> 0.1/s)"
          description: "Orchestrator is experiencing timeout rates exceeding 0.1 per second. System performance may be impacted."
          runbook_url: "https://internal.runbook/orchestrator-timeout"

      - alert: OrchestratorFailureCritical
        expr: rate(devflow_orchestrator_failures_total[5m]) > 0.2
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Orchestrator failure rate critically high (> 0.2/s)"
          description: "Orchestrator failure rate has exceeded 0.2 per second. Immediate remediation required."
          runbook_url: "https://internal.runbook/orchestrator-failure"

  - name: devflow-database
    rules:
      # Database Performance Degradation
      - alert: DatabaseQueryLatencyCritical
        expr: avg(rate(devflow_database_query_duration_seconds_sum[5m]) / rate(devflow_database_query_duration_seconds_count[5m])) > 5
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Database query latency critically high (> 5s)"
          description: "Average database query latency has exceeded 5 seconds for more than 1 minute. Database performance severely degraded."
          runbook_url: "https://internal.runbook/database-performance"

      - alert: DatabaseQueryLatencyWarning
        expr: avg(rate(devflow_database_query_duration_seconds_sum[5m]) / rate(devflow_database_query_duration_seconds_count[5m])) > 2
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Database query latency elevated (> 2s)"
          description: "Average database query latency has exceeded 2 seconds for more than 5 minutes. Database performance degradation detected."
          runbook_url: "https://internal.runbook/database-performance"

      - alert: DatabaseConnectionPoolExhausted
        expr: devflow_database_connections_used / devflow_database_connections_max > 0.95
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Database connection pool nearly exhausted (> 95%)"
          description: "Database connection pool usage has exceeded 95%. Risk of connection failures imminent."
          runbook_url: "https://internal.runbook/database-connection-pool"

  - name: devflow-system-resources
    rules:
      # Memory Usage Alerts
      - alert: MemoryUsageCritical
        expr: (devflow_memory_usage_bytes / devflow_memory_limit_bytes) > 0.9
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "Memory usage critically high (> 90%)"
          description: "System memory usage has exceeded 90% for more than 1 minute. Risk of OOM conditions."
          runbook_url: "https://internal.runbook/memory-usage"

      - alert: MemoryUsageWarning
        expr: (devflow_memory_usage_bytes / devflow_memory_limit_bytes) > 0.75
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Memory usage elevated (> 75%)"
          description: "System memory usage has exceeded 75% for more than 5 minutes. Monitoring recommended."
          runbook_url: "https://internal.runbook/memory-usage"

      # CPU Usage Alerts
      - alert: CPUUsageCritical
        expr: rate(devflow_cpu_usage_seconds_total[5m]) > 0.85
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "CPU usage critically high (> 85%)"
          description: "System CPU usage has exceeded 85% for more than 1 minute. Performance degradation likely."
          runbook_url: "https://internal.runbook/cpu-usage"

  - name: devflow-service-availability
    rules:
      # Service Availability Monitoring
      - alert: ServiceDownCritical
        expr: up{job="devflow"} == 0
        for: 30s
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "DevFlow service is down"
          description: "DevFlow service is not responding. Immediate attention required."
          runbook_url: "https://internal.runbook/service-down"

      - alert: ServiceHealthDegraded
        expr: devflow_service_health_score < 0.8
        for: 2m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "Service health degraded (< 0.8)"
          description: "DevFlow service health score has dropped below 0.8 for more than 2 minutes."
          runbook_url: "https://internal.runbook/service-health"

      # API Response Time Alerts
      - alert: APIResponseTimeCritical
        expr: avg(rate(devflow_api_response_time_seconds_sum[5m]) / rate(devflow_api_response_time_seconds_count[5m])) > 10
        for: 1m
        labels:
          severity: critical
          team: devflow
        annotations:
          summary: "API response time critically high (> 10s)"
          description: "Average API response time has exceeded 10 seconds for more than 1 minute. User experience severely impacted."
          runbook_url: "https://internal.runbook/api-performance"

      - alert: APIResponseTimeWarning
        expr: avg(rate(devflow_api_response_time_seconds_sum[5m]) / rate(devflow_api_response_time_seconds_count[5m])) > 5
        for: 5m
        labels:
          severity: warning
          team: devflow
        annotations:
          summary: "API response time elevated (> 5s)"
          description: "Average API response time has exceeded 5 seconds for more than 5 minutes. User experience may be impacted."
          runbook_url: "https://internal.runbook/api-performance"